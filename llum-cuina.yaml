substitutions:
  device_name: "llum-cuina"
  friendly_name: "llum-cuina"
  static_ip: "10.0.20.34"
  topic_prefix: "llum_cuina"

packages:
  shelly-plus-rgbw-pm: !include 
    file: hardware/shelly-plus-rgbw-pm.yaml
    vars:
      device_name: ${device_name}
      friendly_name: ${friendly_name}

  wifi: !include 
    file: common/wifi.yaml
    vars:
      static_ip: ${static_ip}

  logger: !include common/logger.yaml
  reset: !include common/reset.yaml
  web-server: !include common/web-server.yaml
  # Beware when enabling this since if it cannot connect to the broker it will restart after 15 minutes
  # mqtt: !include common/mqtt.yaml

globals:
  - id: light_state
    type: int
    restore_value: false
    initial_value: "0"
  
light:
  - platform: monochromatic
    id: llum_pica_r
    name: "Llum Pica Cold White"
    output: pwm_r
    restore_mode: ALWAYS_OFF
    default_transition_length: 0s

  - platform: monochromatic
    id: llum_pica_g
    name: "Llum Pica Warm White"
    output: pwm_g
    restore_mode: ALWAYS_OFF
    default_transition_length: 0s

  - platform: monochromatic
    id: llum_barra_b
    name: "Llum Barra Cold White"
    output: pwm_b
    restore_mode: ALWAYS_OFF
    default_transition_length: 0s

  - platform: monochromatic
    id: llum_barra_w
    name: "Llum Barra Warm White"
    output: pwm_w
    restore_mode: ALWAYS_OFF
    default_transition_length: 0s

binary_sensor:
  - platform: gpio
    id: interruptor_entrada_cuina
    name: "${device_name} Input 1"
    pin:
      number: GPIO36
      inverted: true
    filters:
      - delayed_on_off: 50ms
    on_state:
      then:
        - script.execute: cycle_lights
       
  - platform: gpio
    id: interruptor_barra
    name: "${device_name} Input 2"
    pin:
      number: GPIO37
      inverted: true
    filters:
      - delayed_on_off: 50ms
    on_state:
      then:
         - script.execute: cycle_lights

script:
  - id: toggle_llum_barra
    then: 
      if: 
        condition:
          and: 
            - light.is_off: llum_barra_b
            - light.is_off: llum_barra_w
        then:
          - light.turn_on: 
              id: llum_barra_b
              brightness: 50%
          - light.turn_on: 
              id: llum_barra_w
              brightness: 100%
        else:
          - light.turn_off: 
              id: llum_barra_b
              transition_length: 1s
          - light.turn_off: 
              id: llum_barra_w
              transition_length: 1s

  - id: toggle_llum_pica
    then: 
      if: 
        condition:
          and: 
            - light.is_off: llum_pica_r
            - light.is_off: llum_pica_g
        then:
          - light.turn_on: 
              id: llum_pica_r
              brightness: 50%
          - light.turn_on: 
              id: llum_pica_g
              brightness: 100%
        else:
          - light.turn_off: 
              id: llum_pica_r
              transition_length: 1s
          - light.turn_off: 
              id: llum_pica_g
              transition_length: 1s

  - id: cycle_lights
    then:
      - lambda: |-
          ESP_LOGD("test", "Script toggle_lights executed");
          if (id(light_state) == 0) {
            ESP_LOGD("debug", "State 0: Turning ON llum_barra, Turning OFF llum_pica");
            id(toggle_llum_barra).execute(); // turns on llum_barra
            id(light_state) = 1;
          } else if (id(light_state) == 1) {
            ESP_LOGD("debug", "State 1: Turning ON llum_pica, Turning ON llum_barra");
            id(toggle_llum_pica).execute(); // turns on llum_pica
            id(light_state) = 2;
          } else {
            ESP_LOGD("debug", "State 2: Turning OFF both llum_barra and llum_pica");
            id(toggle_llum_barra).execute(); // turns off llum_barra
            id(toggle_llum_pica).execute(); // turns off llum_pica
            id(light_state) = 0;
          }