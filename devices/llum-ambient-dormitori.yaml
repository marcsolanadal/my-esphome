substitutions:
  device_name: "llum-ambient-dormitori"
  device_id: "llum_ambient_dormitori"
  friendly_name: "Llum Ambient Dormitori"
  topic_prefix: "llum_ambient_dormitori"

packages:
  shelly-rgbw2: !include
    file: ../hardware/shelly-rgbw2.yaml
    vars:
      device_name: ${device_name}
      friendly_name: ${friendly_name}

  wifi: !include
    file: ../common/wifi.yaml
    vars:
      device_name: ${device_name}

  mqtt: !include
    file: ../common/mqtt.yaml
    vars:
      device_name: ${device_name}

  logger: !include ../common/logger.yaml
  web-server: !include ../common/web-server.yaml
  reset: !include ../common/reset.yaml
  time: !include ../common/time.yaml

  halt-automations: !include
    file: ../packages/halt-automations.yaml

light:
  - platform: monochromatic
    name: ${device_name}_white
    id: ${device_id}_white
    output: pwm_w

script:
  - id: turn_on_with_time_based_brightness
    then:
      - if:
          condition:
            lambda: 'return !id(halt_automations);'
          then:
            - if:
                condition:
                  or:
                    - lambda: 'return id(sntp_time).now().hour >= 22;'
                    - lambda: 'return id(sntp_time).now().hour < 6;'
                then:
                  - light.turn_on:
                      id: ${device_id}_white
                      brightness: 0.2
                else:
                  - light.turn_on:
                      id: ${device_id}_white
                      brightness: 0.4
          else:
            - light.turn_on:
                id: ${device_id}_white
                brightness: 0.4

binary_sensor:
  - platform: gpio
    pin: GPIO5
    id: light_0_touch
    on_release:
      then:
        - if:
            condition:
              light.is_off: ${device_id}_white
            then:
              - script.execute: turn_on_with_time_based_brightness
            else:
              - light.turn_off: ${device_id}_white
